@model Homeix.Models.Subscription

@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["CreateSubscriptionTitle"];
}

<!-- ================= NON-BLOCKING MODAL FIX ================= -->
<style>
    body.modal-open {
        overflow: auto !important;
        padding-right: 0 !important;
    }

    .modal {
        pointer-events: none;
    }

    .modal-dialog {
        pointer-events: auto;
    }
</style>

<div class="container-fluid mt-4">

    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="page-title">@Localizer["CreateSubscriptionTitle"]</h1>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-7 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">

                    <form asp-action="Create" method="post" id="subscriptionForm">
                        @Html.AntiForgeryToken()

                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <!-- USER -->
                        <div class="mb-3">
                            <label class="form-label">@Localizer["User"]</label>
                            <input class="form-control" value="@User.Identity?.Name" readonly />
                        </div>

                        <!-- PLAN -->
                        <div class="mb-3">
                            <label asp-for="PlanId" class="form-label"></label>
                            <select asp-for="PlanId" class="form-select" id="planSelect">
                                <option value="">@Localizer["SelectPlan"]</option>

                                @foreach (var plan in (IEnumerable<Homeix.Models.SubscriptionPlan>)ViewBag.Plans)
                                {
                                    <option value="@plan.PlanId"
                                            data-name="@plan.PlanName"
                                            data-price="@plan.Price"
                                            data-duration="@plan.DurationDays">
                                        @plan.PlanName
                                    </option>
                                }
                            </select>
                            <span asp-validation-for="PlanId" class="text-danger"></span>
                        </div>

                        <!-- DATE PREVIEW -->
                        <div class="mb-3">
                            <label class="form-label">@Localizer["StartDate"]</label>
                            <input class="form-control" id="previewStart" readonly />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@Localizer["EndDate"]</label>
                            <input class="form-control" id="previewEnd" readonly />
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <button type="button" class="btn btn-primary" id="openModalBtn">
                                <i class="bi bi-credit-card"></i>
                                @Localizer["Subscribe"]
                            </button>

                            <button type="button" class="btn btn-secondary" onclick="history.back()">
                                @Localizer["Back"]
                            </button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= SUBSCRIPTION POPUP (NON-BLOCKING) ================= -->
<div class="modal fade"
     id="paymentModal"
     tabindex="-1"
     aria-hidden="true">

    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">@Localizer["ConfirmSubscription"]</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <p><strong>@Localizer["Plan"]:</strong> <span id="mPlan"></span></p>
                <p><strong>@Localizer["Price"]:</strong> <span id="mPrice"></span> JOD</p>
                <p><strong>@Localizer["Duration"]:</strong> <span id="mDuration"></span> @Localizer["Days"]</p>
                <p><strong>@Localizer["Start"]:</strong> <span id="mStart"></span></p>
                <p><strong>@Localizer["End"]:</strong> <span id="mEnd"></span></p>

                <div class="alert alert-info mt-3">
                    @Localizer["SubscriptionReplaceWarning"]
                </div>
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    @Localizer["Back"]
                </button>

                <button type="submit"
                        class="btn btn-success"
                        form="subscriptionForm">
                    @Localizer["ConfirmAndPay"]
                </button>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const planSelect = document.getElementById("planSelect");
            const startPreview = document.getElementById("previewStart");
            const endPreview = document.getElementById("previewEnd");
            const modalEl = document.getElementById("paymentModal");

            const modal = new bootstrap.Modal(modalEl, {
                backdrop: false,
                focus: false,
                keyboard: true
            });

            planSelect.addEventListener("change", function () {
                const opt = this.options[this.selectedIndex];
                if (!opt.dataset.duration) return;

                const start = new Date();
                const end = new Date();
                end.setDate(start.getDate() + parseInt(opt.dataset.duration));

                startPreview.value = start.toISOString().split("T")[0];
                endPreview.value = end.toISOString().split("T")[0];
            });

            document.getElementById("openModalBtn").addEventListener("click", function () {

                const opt = planSelect.options[planSelect.selectedIndex];
                if (!opt || !opt.dataset.name) {
                    alert("@Localizer["SelectPlanAlert"]");
                    return;
                }

                document.getElementById("mPlan").innerText = opt.dataset.name;
                document.getElementById("mPrice").innerText = opt.dataset.price;
                document.getElementById("mDuration").innerText = opt.dataset.duration;
                document.getElementById("mStart").innerText = startPreview.value;
                document.getElementById("mEnd").innerText = endPreview.value;

                modal.show();
            });

            modalEl.addEventListener("hidden.bs.modal", () => {
                document.body.classList.remove("modal-open");
                document.querySelectorAll(".modal-backdrop").forEach(b => b.remove());
            });
        });
    </script>
}
