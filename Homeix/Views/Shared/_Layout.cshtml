@using System.Security.Claims
@inject Homeix.Data.HOMEIXDbContext _context

@{
    var currentCulture = "en";
    var dir = "ltr";
    string? roleName = User.FindFirst(ClaimTypes.Role)?.Value?.ToLower();
}

<!DOCTYPE html>
<html lang="@currentCulture" dir="@dir" class="light-theme">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>@ViewData["Title"] - Homeix</title>

    <!-- Bootstrap -->
    <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Main Theme -->
    <link href="~/css/site.css" rel="stylesheet" asp-append-version="true" />

    @RenderSection("Head", required: false)
</head>

<body class="d-flex flex-column min-vh-100">

    <!-- ==========================================
         NAVBAR
    =========================================== -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-main shadow-sm fixed-top" id="mainNavbar">
            <div class="container-fluid">

                <!-- LOGO -->
                <a class="navbar-brand d-flex align-items-center"
                   asp-controller="Account" asp-action="HomeRedirect">
                    <img src="~/homeixlogo.jpg" height="40" class="me-2 logo-3d" />
                </a>

                <!-- MOBILE TOGGLER -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- COLLAPSE -->
                <div class="collapse navbar-collapse" id="navbarMain">

                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">

                        @if (User.Identity?.IsAuthenticated ?? false)
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-controller="Chat" asp-action="Index">Messages</a>
                            </li>

                            if (roleName == "admin")
                            {
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Posts</a>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" asp-controller="CustomerPosts" asp-action="Index">Customer Posts</a></li>
                                        <li><a class="dropdown-item" asp-controller="WorkerPosts" asp-action="Index">Worker Posts</a></li>
                                        <li><a class="dropdown-item" asp-controller="PostCategories" asp-action="Index">Categories</a></li>
                                    </ul>
                                </li>

                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Payments</a>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" asp-controller="Payments" asp-action="Index">Payments</a></li>
                                        <li><a class="dropdown-item" asp-controller="PaymentMethods" asp-action="Index">Payment Methods</a></li>
                                        <li><a class="dropdown-item" asp-controller="SubscriptionPlans" asp-action="Index">Plans</a></li>
                                        <li><a class="dropdown-item" asp-controller="Subscriptions" asp-action="Index">Subscriptions</a></li>
                                    </ul>
                                </li>

                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Users</a>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" asp-controller="Users" asp-action="Index">Users</a></li>
                                        <li><a class="dropdown-item" asp-controller="UserRoles" asp-action="Index">Roles</a></li>
                                    </ul>
                                </li>

                                <li class="nav-item"><a class="nav-link" asp-controller="JobProgresses" asp-action="Index">Job Progress</a></li>
                                <li class="nav-item"><a class="nav-link" asp-controller="WorkerApprovals" asp-action="Index">Worker Applications</a></li>
                            }
                            else if (roleName == "customer")
                            {
                                <li class="nav-item"><a class="nav-link" asp-controller="CustomerPosts" asp-action="MyPosts">My Posts</a></li>
                                <li class="nav-item"><a class="nav-link" asp-controller="FavoritePosts" asp-action="Index">My Favorites</a></li>
                                <li class="nav-item"><a class="nav-link" asp-controller="JobProgresses" asp-action="Index">History</a></li>
                                <li class="nav-item"><a class="nav-link" asp-controller="WorkerApprovals" asp-action="Index">Become a Professional</a></li>
                            }
                            else if (roleName == "worker")
                            {
                                <li class="nav-item"><a class="nav-link" asp-controller="WorkerPosts" asp-action="MyPosts">My Posts</a></li>
                                <li class="nav-item"><a class="nav-link" asp-controller="FavoritePosts" asp-action="Index">My Favorites</a></li>
                                <li class="nav-item"><a class="nav-link" asp-controller="JobProgresses" asp-action="Index">History</a></li>
                            }
                        }

                    </ul>

                    <!-- RIGHT SIDE BUTTONS -->
                    <div class="d-flex align-items-center gap-2 flex-wrap">

                        <!-- ✅ RESPONSIVE LANGUAGE DROPDOWN -->
                        <div class="dropdown lang-dropdown">
                            <button class="btn btn-outline-light btn-sm dropdown-toggle w-100 w-lg-auto"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                🌐 <span class="d-none d-md-inline">Language</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-responsive">
                                <li><button class="dropdown-item lang-btn" data-lang="en">English</button></li>
                                <li><button class="dropdown-item lang-btn" data-lang="ar">العربية</button></li>
                            </ul>
                        </div>

                        <!-- THEME TOGGLE -->
                        <button id="themeToggle" class="btn btn-outline-light btn-sm">
                            <span id="themeIcon">🌙</span>
                        </button>

                        @if (User.Identity?.IsAuthenticated ?? false)
                        {
                            <div class="dropdown">
                                <a class="btn btn-outline-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                    @User.Identity!.Name <small>(@roleName)</small>
                                </a>

                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" asp-controller="Account" asp-action="MyProfile">My Profile</a></li>
                                    <li><hr class="dropdown-divider" /></li>
                                    <li>
                                        <form asp-controller="Account" asp-action="LogoutPost" method="post" class="px-3">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-danger btn-sm w-100">Logout</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        }
                        else
                        {
                            <a asp-controller="Account" asp-action="Login" class="btn btn-accent btn-sm">Login</a>
                        }

                    </div>

                </div>
            </div>
        </nav>
    </header>

    <!-- PAGE CONTENT -->
    <main class="container-fluid flex-grow-1 py-4">
        @RenderBody()
    </main>

    <!-- FOOTER -->
    <footer class="footer text-center mt-auto">
        <div class="container py-3">
            © 2025 - Homeix
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const nav = document.getElementById("mainNavbar");
            document.body.style.paddingTop = nav.offsetHeight + "px";
        });
    </script>

    <!-- ✅ LANGUAGE SCRIPT -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const root = document.documentElement;
            const lang = localStorage.getItem("lang") || "en";

            applyLang(lang);

            document.querySelectorAll(".lang-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const selected = btn.dataset.lang;
                    localStorage.setItem("lang", selected);
                    applyLang(selected);

                    // close dropdown on mobile
                    btn.closest(".dropdown-menu")
                       ?.previousElementSibling?.click();
                });
            });

            function applyLang(lang) {
                root.lang = lang;
                root.dir = lang === "ar" ? "rtl" : "ltr";
            }
        });
    </script>

    <!-- THEME TOGGLE SCRIPT -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const root = document.documentElement;
            const icon = document.getElementById("themeIcon");
            const btn = document.getElementById("themeToggle");
            const saved = localStorage.getItem("theme") || "light";

            if (saved === "dark") {
                root.classList.add("dark-theme");
                icon.textContent = "🌙";
            } else {
                icon.textContent = "☀️";
            }

            btn.addEventListener("click", () => {
                const isDark = root.classList.toggle("dark-theme");
                localStorage.setItem("theme", isDark ? "dark" : "light");
                icon.textContent = isDark ? "🌙" : "☀️";
            });
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)

    @inject Homeix.Data.HOMEIXDbContext _context

    @{
        var rand = new Random();
        bool showAd = rand.Next(0, 100) < 20;

        List<Homeix.Models.Advertisement> ads = new();

        if (showAd)
        {
            ads = _context.Advertisements
            .Where(a =>
            a.IsActive &&
            a.StartDate <= DateTime.Today &&
            a.EndDate >= DateTime.Today)
            .OrderBy(a => Guid.NewGuid())
            .Take(1)
            .ToList();
        }
    }

    <partial name="_AdvertisementRotator" model="ads" />

</body>
</html>
