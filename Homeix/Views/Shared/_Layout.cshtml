@using System.Security.Claims
@inject Homeix.Data.HOMEIXDbContext _context

@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    string roleName = User.FindFirst(ClaimTypes.Role)?.Value?.ToLower() ?? "";
    var culture = System.Threading.Thread.CurrentThread.CurrentUICulture;
}

<!DOCTYPE html>
<html lang="@culture.TwoLetterISOLanguageName" dir="@(culture.TextInfo.IsRightToLeft ? "rtl" : "ltr")" class="light-theme">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>@ViewData["Title"] - Homeix</title>

    <link rel="icon" type="image/x-icon" href="~/favicon.ico?v=1" />

    <!-- Bootstrap -->
    <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Main Theme -->
    <link href="~/css/site.css" rel="stylesheet" asp-append-version="true" />

    @RenderSection("Head", required: false)
</head>

<body class="d-flex flex-column min-vh-100">

    <!-- Background FX -->
    <div class="homeix-body-bg" aria-hidden="true">
        <span class="homeix-tool tool-wrench"></span>
        <span class="homeix-tool tool-hammer"></span>
        <span class="homeix-tool tool-drill"></span>
    </div>

    <!-- ================= NAVBAR ================= -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top homeix-float-nav" id="mainNavbar">
            <div class="container-fluid homeix-nav-shell bg-main shadow-sm">

                <a class="navbar-brand d-flex align-items-center"
                   asp-controller="Account"
                   asp-action="HomeRedirect">
                    <img src="~/homeixlogo.jpg"
                         class="homeix-logo-round me-2"
                         alt="@Localizer["AppName"]" />
                </a>

                <button class="navbar-toggler"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#navbarMain"
                        aria-controls="navbarMain"
                        aria-expanded="false"
                        aria-label="@Localizer["ToggleNavigation"]">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse homeix-collapse-panel" id="navbarMain">

                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">

                        @if (User.Identity?.IsAuthenticated ?? false)
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-controller="Chat" asp-action="Index">
                                    @Localizer["Messages"]
                                </a>
                            </li>

                            if (roleName == "admin")
                            {
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                                        @Localizer["Posts"]
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" asp-controller="CustomerPosts" asp-action="Index">@Localizer["CustomerPosts"]</a></li>
                                        <li><a class="dropdown-item" asp-controller="WorkerPosts" asp-action="Index">@Localizer["WorkerPosts"]</a></li>
                                        <li><a class="dropdown-item" asp-controller="PostCategories" asp-action="Index">@Localizer["Categories"]</a></li>
                                    </ul>
                                </li>

                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                                        @Localizer["Payments"]
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" asp-controller="Payments" asp-action="Index">@Localizer["Payments"]</a></li>
                                        <li><a class="dropdown-item" asp-controller="PaymentMethods" asp-action="Index">@Localizer["PaymentMethods"]</a></li>
                                        <li><a class="dropdown-item" asp-controller="SubscriptionPlans" asp-action="Index">@Localizer["Plans"]</a></li>
                                        <li><a class="dropdown-item" asp-controller="Subscriptions" asp-action="Index">@Localizer["Subscriptions"]</a></li>
                                    </ul>
                                </li>

                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                                        @Localizer["Users"]
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" asp-controller="Users" asp-action="Index">@Localizer["Users"]</a></li>
                                        <li><a class="dropdown-item" asp-controller="UserRoles" asp-action="Index">@Localizer["Roles"]</a></li>
                                        <li><a class="dropdown-item" asp-controller="Ratings" asp-action="Index">@Localizer["Ratings"]</a></li>
                                    </ul>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" asp-controller="WorkerApprovals" asp-action="Index">
                                        @Localizer["WorkerApplications"]
                                    </a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" asp-controller="Advertisements" asp-action="Index">
                                        @Localizer["Advertisements"]
                                    </a>
                                </li>
                            }
                            else if (roleName == "customer")
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-controller="CustomerPosts" asp-action="MyPosts">
                                        @Localizer["MyPosts"]
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" asp-controller="SubscriptionPlans" asp-action="Explore">
                                        @Localizer["ExplorePlans"]
                                    </a>
                                </li>
                            }
                            else if (roleName == "worker")
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-controller="WorkerPosts" asp-action="MyPosts">
                                        @Localizer["MyPosts"]
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" asp-controller="SubscriptionPlans" asp-action="Explore">
                                        @Localizer["ExplorePlans"]
                                    </a>
                                </li>
                            }
                        }
                    </ul>

                    <!-- RIGHT SIDE -->
                    <div class="d-flex align-items-center gap-2 flex-wrap">

                        <button id="langToggle"
                                class="btn btn-outline-light btn-sm lang-icon-btn"
                                type="button"
                                aria-label="@Localizer["ToggleLanguage"]">
                            <span class="lang-icon">
                                <span class="lang-tile tile-a">A</span>
                                <span class="lang-tile tile-ar">ع</span>
                            </span>
                        </button>

                        <button id="themeToggle"
                                class="btn btn-outline-light btn-sm"
                                aria-label="@Localizer["ToggleTheme"]">
                            <span id="themeIcon">🌙</span>
                        </button>

                        @if (User.Identity?.IsAuthenticated ?? false)
                        {
                            <div class="dropdown">
                                <a class="btn btn-outline-light btn-sm dropdown-toggle"
                                   data-bs-toggle="dropdown">
                                    @User.Identity!.Name
                                    <small class="text-capitalize">(@roleName)</small>
                                </a>

                                <ul class="dropdown-menu dropdown-menu-end">

                                    <li>
                                        <a class="dropdown-item" asp-controller="Account" asp-action="MyProfile">
                                            @Localizer["MyProfile"]
                                        </a>
                                    </li>

                                    @if (roleName == "worker")
                                    {
                                        <li>
                                            <a class="dropdown-item"
                                               asp-controller="Subscriptions"
                                               asp-action="MySubscriptions">
                                                @Localizer["MySubscriptions"]
                                            </a>
                                        </li>
                                    }
                                    else if (roleName == "customer")
                                    {
                                        <li>
                                            <a class="dropdown-item"
                                               asp-controller="Subscriptions"
                                               asp-action="MySubscriptions">
                                                @Localizer["MySubscriptions"]
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item"
                                               asp-controller="WorkerApprovals"
                                               asp-action="MyRequests">
                                                @Localizer["ApplyForWorkerRole"]
                                            </a>
                                        </li>
                                    }

                                    <li><hr class="dropdown-divider" /></li>

                                    <li>
                                        <form asp-controller="Account"
                                              asp-action="LogoutPost"
                                              method="post"
                                              class="px-3">
                                            @Html.AntiForgeryToken()
                                            <button type="submit"
                                                    class="btn btn-danger btn-sm w-100">
                                                @Localizer["Logout"]
                                            </button>
                                        </form>
                                    </li>

                                </ul>
                            </div>
                        }
                        else
                        {
                            <a asp-controller="Account"
                               asp-action="Login"
                               class="btn btn-accent btn-sm">
                                @Localizer["Login"]
                            </a>
                        }
                    </div>

                </div>
            </div>
        </nav>
    </header>


    <!-- CONTENT -->
    <main class="container-fluid flex-grow-1 py-4">
        @RenderBody()
    </main>
    <!-- FOOTER -->
    <footer class="footer mt-auto bg-dark text-light">
        <div class="container py-4 small">

            <!-- MAIN CONTENT -->
            <div class="row text-center gy-3 align-items-start">

                <!-- HOMEIX -->
                <div class="col-md-4">
                    <strong class="d-block mb-1">
                        @Localizer["AppName"]
                    </strong>

                    <div class="opacity-75 mb-2">
                        @Localizer["FooterTagline"]
                    </div>

                    <a asp-controller="Home"
                       asp-action="AboutUs"
                       class="link-light text-decoration-none opacity-75 d-block mb-2">
                        @Localizer["AboutUs"]
                    </a>

                    <!-- APK DOWNLOAD -->
                    <a asp-controller="Downloads"
                       asp-action="MobileApp"
                       class="btn btn-outline-light btn-sm mt-2">
                        <i class="bi bi-android2 me-1"></i>
                        @Localizer["DownloadApp"]
                    </a>
                </div>

                <!-- CONTACT -->
                <div class="col-md-4">
                    <strong class="d-block mb-1">
                        @Localizer["Contact"]
                    </strong>

                    <div class="opacity-75">
                        <div>
                            <i class="bi bi-geo-alt me-2"></i>
                            @Localizer["Location"]
                        </div>

                        <div>
                            <i class="bi bi-envelope me-2"></i>
                            <a href="mailto:homeix.jo@gmail.com"
                               class="link-light text-decoration-none">
                                homeix.jo@gmail.com
                            </a>
                        </div>
                    </div>
                </div>

                <!-- FOLLOW -->
                <div class="col-md-4">
                    <strong class="d-block mb-1">
                        @Localizer["FollowUs"]
                    </strong>

                    <div class="opacity-75 d-flex justify-content-center gap-4">
                        <a class="link-light text-decoration-none fs-5"
                           href="https://www.linkedin.com"
                           target="_blank"
                           rel="noopener">
                            <i class="bi bi-linkedin"></i>
                        </a>

                        <a class="link-light text-decoration-none fs-5"
                           href="#"
                           target="_blank"
                           rel="noopener">
                            <i class="bi bi-facebook"></i>
                        </a>

                        <a class="link-light text-decoration-none fs-5"
                           href="#"
                           target="_blank"
                           rel="noopener">
                            <i class="bi bi-instagram"></i>
                        </a>
                    </div>
                </div>

            </div>

            <!-- COPYRIGHT -->
            <div class="row mt-4">
                <div class="col text-center opacity-75">
                    © 2026 @Localizer["AppName"] · Graduation Project at HTU
                </div>
            </div>
        </div>
    </footer>


    <!-- ===== Hidden culture forms (required for cookie switch) ===== -->
    <form id="langFormAR"
          asp-controller="Language"
          asp-action="SetLanguage"
          method="post"
          class="d-none">
        @Html.AntiForgeryToken()
        <input type="hidden" name="culture" value="ar-JO" />
        <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
    </form>

    <form id="langFormEN"
          asp-controller="Language"
          asp-action="SetLanguage"
          method="post"
          class="d-none">
        @Html.AntiForgeryToken()
        <input type="hidden" name="culture" value="en-US" />
        <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
    </form>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <!-- NAVBAR HEIGHT SYNC -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const nav = document.getElementById("mainNavbar");
            const collapse = document.getElementById("navbarMain");

            const sync = () => document.body.style.paddingTop = nav.offsetHeight + "px";
            sync();

            window.addEventListener("resize", sync);
            collapse?.addEventListener("shown.bs.collapse", sync);
            collapse?.addEventListener("hidden.bs.collapse", sync);
        });
    </script>

    <!-- LANGUAGE (server-side cookie switch) -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const btn = document.getElementById("langToggle");
            const html = document.documentElement;

            btn?.addEventListener("click", () => {
                const isArabic = html.lang === "ar";

                if (isArabic) {
                    document.getElementById("langFormEN").submit();
                } else {
                    document.getElementById("langFormAR").submit();
                }
            });
        });
    </script>

    <!-- THEME -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const root = document.documentElement;
            const icon = document.getElementById("themeIcon");

            const saved = localStorage.getItem("theme") || "light";
            if (saved === "dark") root.classList.add("dark-theme");

            icon.textContent = root.classList.contains("dark-theme") ? "🌙" : "☀️";

            document.getElementById("themeToggle").onclick = () => {
                root.classList.toggle("dark-theme");
                localStorage.setItem(
                    "theme",
                    root.classList.contains("dark-theme") ? "dark" : "light"
                );
                icon.textContent = root.classList.contains("dark-theme") ? "🌙" : "☀️";
            };
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)

    @{
        var showAd = new Random().Next(0, 100) < 20;

        var ads = showAd
        ? _context.Advertisements
        .Where(a => a.IsActive &&
        a.StartDate <= DateTime.Today &&
        a.EndDate >= DateTime.Today)
        .OrderBy(a => Guid.NewGuid())
        .Take(1)
        .ToList()
        : new List<Homeix.Models.Advertisement>();
    }

    <partial name="_AdvertisementRotator" model="ads" />

</body>
</html>
