@model Homeix.Models.User
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["MyProfile"];

    var profileImage = string.IsNullOrWhiteSpace(Model.ProfilePicture)
        ? Url.Content("~/images/default-user.png")
        : Url.Content(Model.ProfilePicture);
}

<div class="container mt-4 mb-5">

    <!-- ================= IMAGE SECTION ================= -->
    <div class="card shadow-sm mb-4 overflow-hidden">

        <label for="ProfileImageInput" style="cursor:pointer;">
            <img id="profilePreview"
                 src="@profileImage"
                 class="d-block w-100 img-fluid bg-light"
                 style="max-height:420px; object-fit:contain;"
                 title="@Localizer["ChangeProfilePicture"]" />
        </label>

    </div>

    <!-- ================= DETAILS SECTION ================= -->
    <div class="card shadow-sm">
        <div class="card-body">

            @if (ViewBag.Success != null)
            {
                <div class="alert alert-success text-center mb-3">
                    @ViewBag.Success
                </div>
            }

            <form asp-action="MyProfile"
                  method="post"
                  enctype="multipart/form-data">

                @Html.AntiForgeryToken()

                <!-- HIDDEN FILE INPUT -->
                <input type="file"
                       id="ProfileImageInput"
                       name="ProfileImage"
                       accept="image/*"
                       hidden />

                <!-- REQUIRED HIDDEN -->
                <input type="hidden" asp-for="UserId" />
                <input type="hidden" asp-for="RoleId" />

                <!-- NAME -->
                <h3 class="fw-bold mb-1">@Model.FullName</h3>

                <!-- META LINE -->
                <div class="text-muted small d-flex align-items-center flex-wrap gap-3 mb-4">

                    <span class="badge bg-primary">
                        <i class="bi bi-person-badge"></i> @Model.Role?.RoleName
                    </span>

                    <span class="d-flex align-items-center gap-1">
                        <i class="bi bi-envelope"></i> @Model.Email
                    </span>

                    <span class="d-flex align-items-center gap-1">
                        <i class="bi bi-telephone"></i> @Model.PhoneNumber
                    </span>

                </div>

                <hr />

                <!-- FULL NAME -->
                <div class="mb-3">
                    <label asp-for="FullName" class="form-label fw-semibold">
                        @Localizer["FullName"]
                    </label>
                    <input asp-for="FullName"
                           class="form-control"
                           pattern="^[A-Za-z .]+$"
                           title="@Localizer["FullNameRule"]" />
                    <span asp-validation-for="FullName" class="text-danger"></span>
                </div>

                <!-- EMAIL -->
                <div class="mb-3">
                    <label asp-for="Email" class="form-label fw-semibold">
                        @Localizer["Email"]
                    </label>
                    <input asp-for="Email"
                           type="email"
                           class="form-control" />
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>

                <!-- PHONE -->
                <div class="mb-3">
                    <label asp-for="PhoneNumber" class="form-label fw-semibold">
                        @Localizer["PhoneNumber"]
                    </label>
                    <input asp-for="PhoneNumber"
                           class="form-control"
                           pattern="^[0-9+]+$"
                           title="@Localizer["PhoneRule"]" />
                    <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                </div>

                <hr />

                <!-- PASSWORD -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">
                        @Localizer["NewPassword"]
                        <span class="text-muted">(@Localizer["Optional"])</span>
                    </label>
                    <input name="NewPassword"
                           type="password"
                           class="form-control"
                           minlength="8" />
                    <div class="form-text">
                        @Localizer["PasswordHint"]
                    </div>
                </div>

                <!-- ACTIONS -->
                <div class="d-flex justify-content-between flex-wrap gap-2">

                    <button type="submit"
                            class="btn btn-primary">
                        <i class="bi bi-check-circle"></i>
                        @Localizer["UpdateProfile"]
                    </button>

                    <button type="button"
                            class="btn btn-secondary"
                            onclick="history.back()">
                        <i class="bi bi-arrow-left"></i>
                        @Localizer["Back"]
                    </button>

                </div>

            </form>

            <hr />

            <!-- DELETE ACCOUNT -->
            <form asp-action="DeleteMyAccount"
                  method="post"
                  class="mt-3"
                  onsubmit="return confirm('@Localizer["DeleteConfirm"]');">

                @Html.AntiForgeryToken()

                <button type="submit"
                        class="btn btn-danger w-100">
                    <i class="bi bi-trash"></i>
                    @Localizer["DeleteAccount"]
                </button>

            </form>

        </div>
    </div>

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const imageInput = document.getElementById("ProfileImageInput");
            const imagePreview = document.getElementById("profilePreview");

            imageInput?.addEventListener("change", e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = ev => imagePreview.src = ev.target.result;
                reader.readAsDataURL(file);
            });
        });
    </script>
}
