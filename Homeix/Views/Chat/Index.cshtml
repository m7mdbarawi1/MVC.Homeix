@using Homeix.Models
@{
    ViewData["Title"] = "Chat";

    var users = ViewBag.Users as List<User>;
    var messages = ViewBag.Messages as List<Message>;
    var selectedUser = ViewBag.SelectedUser as User;

    int currentUserId = ViewBag.CurrentUserId;
    int? conversationId = ViewBag.ConversationId;
}

<div class="container-fluid px-0">
    <div class="chat-shell">

        <!-- USERS (Offcanvas on mobile, static sidebar on md+) -->
        <div class="offcanvas offcanvas-start chat-users"
             tabindex="-1"
             id="chatUsers"
             aria-labelledby="chatUsersLabel"
             data-bs-scroll="true">

            <div class="offcanvas-header border-bottom">
                <h5 class="offcanvas-title" id="chatUsersLabel">Chats</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>

            <div class="offcanvas-body p-0">
                <div class="list-group list-group-flush" id="chatUserList">
                    @if (users != null && users.Any())
                    {
                        foreach (var user in users)
                        {
                            bool isActive = selectedUser?.UserId == user.UserId;

                            <a asp-controller="Chat"
                               asp-action="Index"
                               asp-route-userId="@user.UserId"
                               class="list-group-item list-group-item-action @(isActive ? "active" : "")"
                               data-chat-user-id="@user.UserId">

                                <div class="d-flex align-items-center gap-2">
                                    <span class="online-dot" data-user-id="@user.UserId"></span>

                                    <img src="@(string.IsNullOrEmpty(user.ProfilePicture)
                                            ? Url.Content("~/images/default-user.png")
                                            : user.ProfilePicture)"
                                         class="rounded-circle flex-shrink-0"
                                         width="40" height="40"
                                         alt="@(user.FullName)" />

                                    <div class="min-w-0">
                                        <div class="fw-semibold text-truncate">@user.FullName</div>
                                        <small class="text-muted text-truncate d-block">@user.Email</small>
                                    </div>
                                </div>
                            </a>
                        }
                    }
                    else
                    {
                        <div class="p-3 text-muted">No users found.</div>
                    }
                </div>
            </div>
        </div>

        <!-- CHAT MAIN -->
        <div class="chat-main d-flex flex-column">

            <!-- HEADER -->
            <div class="chat-header border-bottom bg-white">
                <div class="d-flex align-items-center justify-content-between gap-2 px-2 px-md-3 py-2">
                    <div class="d-flex align-items-center gap-2 min-w-0">
                        <button class="btn btn-outline-secondary d-md-none"
                                type="button"
                                data-bs-toggle="offcanvas"
                                data-bs-target="#chatUsers"
                                aria-controls="chatUsers">
                            Chats
                        </button>

                        @if (selectedUser != null)
                        {
                            <div class="min-w-0">
                                <div class="fw-semibold text-truncate">@selectedUser.FullName</div>
                                <div class="small text-muted text-truncate" id="typingIndicator" aria-live="polite"></div>
                            </div>
                        }
                        else
                        {
                            <div class="min-w-0">
                                <div class="fw-semibold text-truncate">Chat</div>
                                <div class="small text-muted text-truncate">Select a conversation to start messaging</div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            @if (selectedUser == null)
            {
                <!-- EMPTY STATE -->
                <div class="chat-empty flex-grow-1 d-flex align-items-center justify-content-center text-muted bg-light">
                    <div class="text-center p-4">
                        <div class="mb-3">Select a chat to start messaging</div>
                        <button class="btn btn-primary d-md-none"
                                type="button"
                                data-bs-toggle="offcanvas"
                                data-bs-target="#chatUsers">
                            Open chats
                        </button>
                    </div>
                </div>
            }
            else
            {
                <!-- MESSAGES -->
                <div class="chat-messages flex-grow-1 overflow-auto bg-light" id="messagesScroll">
                    <div class="d-flex flex-column gap-2 p-3" id="messagesContainer">
                        @foreach (var msg in messages ?? new List<Message>())
                        {
                            bool isMe = msg.SenderUserId == currentUserId;

                            <div class="d-flex @(isMe ? "justify-content-end" : "justify-content-start")">
                                <div class="chat-bubble @(isMe ? "chat-bubble-me" : "chat-bubble-them")">
                                    <div class="chat-text">@msg.MessageText</div>
                                    <div class="chat-time text-end">@msg.SentAt.ToString("HH:mm")</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- INPUT -->
                <div class="chat-footer border-top bg-white">
                    <div class="px-2 px-md-3 py-2 py-md-3">
                        <form id="chatForm" class="d-flex align-items-end gap-2">
                            <input type="hidden" id="conversationId" value="@(conversationId ?? 0)" />

                            <textarea id="messageInput"
                                      class="form-control chat-textarea"
                                      placeholder="Type a message..."
                                      rows="1"
                                      required></textarea>

                            <button type="submit" class="btn btn-primary flex-shrink-0">
                                Send
                            </button>
                        </form>

                        <div class="small text-muted mt-1" id="seenIndicator" aria-live="polite"></div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <script>
        const currentUserId = @currentUserId;
        const conversationId = @(conversationId ?? 0);
        const receiverId = @(selectedUser?.UserId ?? 0);

        const chatUserList = document.getElementById("chatUserList");
        const messagesContainer = document.getElementById("messagesContainer");
        const messagesScroll = document.getElementById("messagesScroll");
        const typingIndicator = document.getElementById("typingIndicator");
        const seenIndicator = document.getElementById("seenIndicator");
        const messageInput = document.getElementById("messageInput");

        function scrollToBottom() {
            if (!messagesScroll) return;
            messagesScroll.scrollTop = messagesScroll.scrollHeight;
        }

        function bumpChatUserToTop(userId) {
            if (!chatUserList || !userId) return;

            const item = chatUserList.querySelector(`[data-chat-user-id="${userId}"]`);
            if (!item) return;

            chatUserList.prepend(item);
        }

        function setOnlineDot(userId, isOnline) {
            document
                .querySelectorAll(`.online-dot[data-user-id="${userId}"]`)
                .forEach(el => el.classList.toggle("online", isOnline));
        }

        function appendMessageSafe(data) {
            if (!messagesContainer) return;

            const isMe = data.senderId === currentUserId;

            const row = document.createElement("div");
            row.className = "d-flex " + (isMe ? "justify-content-end" : "justify-content-start");

            const bubble = document.createElement("div");
            bubble.className = "chat-bubble " + (isMe ? "chat-bubble-me" : "chat-bubble-them");

            const text = document.createElement("div");
            text.className = "chat-text";
            text.textContent = data.message ?? ""; // SAFE

            const time = document.createElement("div");
            time.className = "chat-time text-end";
            time.textContent = data.sentAt ?? "";

            bubble.appendChild(text);
            bubble.appendChild(time);
            row.appendChild(bubble);
            messagesContainer.appendChild(row);

            scrollToBottom();
        }

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        (async () => {
            try {
                await connection.start();
                scrollToBottom();
            } catch (e) {
                console.error("SignalR start failed:", e);
            }
        })();

        // ================= RECEIVE MESSAGE =================
        connection.on("ReceiveMessage", data => {
            // Move that chat to top (works even if message is for another conversation)
            const otherUserId = (data.senderId === currentUserId)
                ? (data.receiverId ?? receiverId)
                : data.senderId;

            bumpChatUserToTop(otherUserId);

            // Only render in the open chat if it matches
            if (!conversationId || data.conversationId !== conversationId) return;

            appendMessageSafe(data);

            if (data.senderId !== currentUserId) {
                connection.invoke("MessageSeen", data.senderId, data.conversationId);
            }
        });

        // ================= SEND MESSAGE =================
        document.getElementById("chatForm")?.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!messageInput) return;

            const text = messageInput.value.trim();
            if (!text) return;

            try {
                await connection.invoke("SendMessage", conversationId, currentUserId, receiverId, text);

                messageInput.value = "";
                autoGrow(messageInput);
                if (seenIndicator) seenIndicator.innerText = "";
            } catch (err) {
                console.error(err);
            }
        });

        // Enter to send (Shift+Enter = new line)
        messageInput?.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                document.getElementById("chatForm")?.requestSubmit();
            }
        });

        // Auto-grow textarea
        function autoGrow(el) {
            el.style.height = "auto";
            el.style.height = Math.min(el.scrollHeight, 140) + "px";
        }
        messageInput?.addEventListener("input", () => autoGrow(messageInput));

        // ================= TYPING (throttled) =================
        let typingCooldown = false;
        messageInput?.addEventListener("input", () => {
            if (typingCooldown || !receiverId) return;
            typingCooldown = true;

            connection.invoke("Typing", receiverId, conversationId);
            setTimeout(() => typingCooldown = false, 700);
        });

        connection.on("UserTyping", (data) => {
            if (data?.conversationId && data.conversationId !== conversationId) return;
            if (!typingIndicator) return;

            typingIndicator.innerText = "Typing...";
            clearTimeout(window.__typingTimer);
            window.__typingTimer = setTimeout(() => typingIndicator.innerText = "", 900);
        });

        // ================= ONLINE / OFFLINE =================
        connection.on("UserOnline", id => setOnlineDot(id, true));
        connection.on("UserOffline", id => setOnlineDot(id, false));

        // ================= SEEN =================
        connection.on("MessageSeen", (data) => {
            if (data?.conversationId && data.conversationId !== conversationId) return;
            if (seenIndicator) seenIndicator.innerText = "Seen ✔";
        });
    </script>
}