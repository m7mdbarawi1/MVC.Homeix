@model Homeix.Models.CustomerPost
@using Homeix.Models
@using System.Linq

@functions {
    string NormalizePath(string? path)
    {
        return string.IsNullOrWhiteSpace(path)
            ? "/images/no-image.png"
            : path.Replace("\\", "/");
    }
}

@{
    ViewData["Title"] = "Customer Post Details";

    var mediaList = (Model.Media ?? new List<CustomerPostMedia>())
        .Where(m => !string.IsNullOrWhiteSpace(m.MediaPath))
        .OrderByDescending(m => m.MediaId)
        .ToList();

    bool hasMedia = mediaList.Any();
    bool isAdmin = User.IsInRole("admin");
}

<div class="container mt-4 mb-5">

    <!-- ================= IMAGES SECTION ================= -->
    <div class="card shadow-sm mb-4 overflow-hidden">

        @if (hasMedia && mediaList.Count > 1)
        {
                <div id="customerPostCarousel"
                     class="carousel slide"
                     data-bs-ride="carousel">

                    <div class="carousel-inner bg-secondary bg-opacity-10">
                    @for (int i = 0; i < mediaList.Count; i++)
                    {
                        var imageUrl = NormalizePath(mediaList[i].MediaPath);

                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="@imageUrl"
                                         class="d-block w-100 img-fluid"
                                         style="max-height:520px; object-fit:contain;"
                                         alt="Post image @(i + 1)" />
                                </div>
                    }
                    </div>

                    <button class="carousel-control-prev"
                            type="button"
                            data-bs-target="#customerPostCarousel"
                            data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>

                    <button class="carousel-control-next"
                            type="button"
                            data-bs-target="#customerPostCarousel"
                            data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>
        }
        else
        {
            var imageUrl = hasMedia
                ? NormalizePath(mediaList.First().MediaPath)
                : "/images/no-image.png";

                <img src="@imageUrl"
                     class="d-block w-100 img-fluid bg-light"
                     style="max-height:520px; object-fit:contain;"
                     alt="Post image" />
        }

    </div>

    <!-- ================= DETAILS SECTION ================= -->
    <div class="card shadow-sm">
        <div class="card-body">

            <!-- TITLE -->
            <h3 class="fw-bold mb-1">@Model.Title</h3>

            <!-- META LINE -->
            <div class="text-muted small d-flex align-items-center flex-wrap gap-2 mb-3">

                @if (!string.IsNullOrWhiteSpace(Model.PostCategory?.CategoryName))
                {
                        <span class="badge bg-primary">
                            <i class="bi bi-tags"></i> @Model.PostCategory.CategoryName
                        </span>
                }

                <span class="d-flex align-items-center gap-1">
                    <i class="bi bi-geo-alt"></i> @Model.Location
                </span>

                <span class="d-flex align-items-center gap-1">
                    <i class="bi bi-calendar3"></i>
                    @Model.CreatedAt.ToString("yyyy-MM-dd")
                </span>

            </div>

            <hr />

            <!-- PRICE -->
            <div class="mb-3">
                <div class="text-muted small">Price</div>
                <div class="fs-4 fw-bold text-success">
                    @(Model.PriceRangeMin.HasValue || Model.PriceRangeMax.HasValue
                            ? $"{Model.PriceRangeMin} – {Model.PriceRangeMax} JD"
                            : "Price not specified")
                </div>
            </div>

            <hr />

            <!-- OWNER -->
            <div class="d-flex align-items-center gap-3 mb-3">

                <img src="@(string.IsNullOrEmpty(Model.User?.ProfilePicture)
                        ? Url.Content("~/images/default-user.png")
                        : Url.Content($"~/uploads/profile/{Model.User.ProfilePicture}"))"
                     class="rounded-circle flex-shrink-0"
                     width="44"
                     height="44"
                     alt="@Model.User?.FullName"
                     style="object-fit:cover;" />

                <div>
                    <a asp-controller="Users"
                       asp-action="PublicProfile"
                       asp-route-id="@Model.UserId"
                       class="fw-semibold text-decoration-none">
                        @Model.User?.FullName
                    </a>
                </div>

            </div>

            <hr />

            <!-- DESCRIPTION -->
            <div class="fw-bold mb-2">Description</div>
            <div class="text-muted" style="white-space:pre-line;">
                @Model.Description
            </div>

        </div>

        <!-- ================= ACTIONS ================= -->
        <div class="card-footer d-flex justify-content-between flex-wrap gap-2">

            <button type="button"
                    class="btn btn-secondary btn-sm d-inline-flex align-items-center gap-1"
                    onclick="history.back()">
                <i class="bi bi-arrow-left"></i>
                Back
            </button>

            <div class="d-flex gap-2">

                @* HIDE RATE BUTTON FOR ADMIN ONLY *@
                @if (!isAdmin)
                {
                        <a asp-controller="Ratings"
                           asp-action="Create"
                           asp-route-ratedUserId="@Model.UserId"
                           class="btn btn-accent btn-sm d-inline-flex align-items-center gap-1">
                            <i class="bi bi-star"></i>
                            Rate
                        </a>
                }

                <a asp-controller="Chat"
                   asp-action="Index"
                   asp-route-userId="@Model.UserId"
                   class="btn btn-primary btn-sm d-inline-flex align-items-center gap-1">
                    <i class="bi bi-chat-dots"></i>
                    Chat
                </a>
            </div>

        </div>
    </div>

</div>
