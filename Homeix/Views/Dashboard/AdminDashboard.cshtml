@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid px-4 py-3 vh-100 d-flex flex-column overflow-hidden">

    <!-- HEADER -->
    <div class="mb-3">
        <h2 class="fw-bold mb-1">
            <i class="bi bi-speedometer2 me-2 text-primary"></i>
            Admin Dashboard
        </h2>
        <p class="text-muted mb-0">Platform analytics overview</p>
    </div>

    <!-- DASHBOARD CONTENT -->
    <div class="flex-grow-1 d-flex flex-column gap-4">

        <!-- TOP ROW -->
        <div class="row g-4 flex-grow-1">

            <!-- USERS BY ROLE -->
            <div class="col-xl-4 col-md-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h6 class="text-muted fw-bold mb-3">Users by Role</h6>
                        <div class="flex-grow-1">
                            <canvas id="usersChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- POSTS DISTRIBUTION -->
            <div class="col-xl-4 col-md-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h6 class="text-muted fw-bold mb-3">Posts Distribution</h6>
                        <div class="flex-grow-1">
                            <canvas id="postsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- JOB STATUS -->
            <div class="col-xl-4 col-md-12">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h6 class="text-muted fw-bold mb-3">Job Status</h6>
                        <div class="flex-grow-1">
                            <canvas id="jobsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- BOTTOM ROW -->
        <div class="row g-4 flex-grow-1">

            <!-- MONTHLY REVENUE -->
            <div class="col-xl-8 col-md-12">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h6 class="text-muted fw-bold mb-3">Monthly Revenue (JD)</h6>
                        <div class="flex-grow-1">
                            <canvas id="paymentsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RATINGS -->
            <div class="col-xl-4 col-md-12">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-muted fw-bold mb-0">Ratings Overview</h6>
                            <span class="badge bg-warning text-dark">
                                ⭐ @ViewBag.AverageRating / 5
                            </span>
                        </div>

                        <small class="text-muted mb-2">
                            Distribution of user ratings
                        </small>

                        <div class="flex-grow-1">
                            <canvas id="ratingsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

@section Scripts {
    <script>
        const baseOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        };

        // USERS BY ROLE
        new Chart(document.getElementById('usersChart'), {
            type: 'bar',
            data: {
                labels: @Html.Raw(ViewBag.UsersByRoleLabels ?? "[]"),
                datasets: [{
                    data: @Html.Raw(ViewBag.UsersByRoleCounts ?? "[]"),
                    backgroundColor: '#0d6efd'
                }]
            },
            options: baseOptions
        });

        // POSTS
        new Chart(document.getElementById('postsChart'), {
            type: 'doughnut',
            data: {
                labels: ['Customer Posts', 'Worker Posts'],
                datasets: [{
                    data: [@ViewBag.CustomerPostsCount, @ViewBag.WorkerPostsCount],
                    backgroundColor: ['#0dcaf0', '#ffc107']
                }]
            },
            options: baseOptions
        });

        // JOB STATUS
        new Chart(document.getElementById('jobsChart'), {
            type: 'pie',
            data: {
                labels: @Html.Raw(ViewBag.JobStatusLabels ?? "[]"),
                datasets: [{
                    data: @Html.Raw(ViewBag.JobStatusCounts ?? "[]"),
                    backgroundColor: ['#0dcaf0', '#0d6efd', '#198754', '#dc3545']
                }]
            },
            options: baseOptions
        });

        // PAYMENTS
        new Chart(document.getElementById('paymentsChart'), {
            type: 'line',
            data: {
                labels: @Html.Raw(ViewBag.PaymentMonths ?? "[]"),
                datasets: [{
                    data: @Html.Raw(ViewBag.PaymentTotals ?? "[]"),
                    borderColor: '#6610f2',
                    backgroundColor: 'rgba(102,16,242,0.15)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: baseOptions
        });

        // RATINGS
        new Chart(document.getElementById('ratingsChart'), {
            type: 'bar',
            data: {
                labels: ['⭐ 5', '⭐ 4', '⭐ 3', '⭐ 2', '⭐ 1'],
                datasets: [{
                    data: @Html.Raw(ViewBag.RatingCounts ?? "[]"),
                    backgroundColor: [
                        '#198754',
                        '#20c997',
                        '#ffc107',
                        '#fd7e14',
                        '#dc3545'
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.raw} ratings`
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });
    </script>
}
