@model Homeix.Models.User

@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["EditUserTitle"];

    // IMPORTANT:
    // ProfilePicture already stores "/uploads/profile/filename.jpg"
    var profileImage = string.IsNullOrWhiteSpace(Model.ProfilePicture)
        ? Url.Content("~/images/default-user.png")
        : Url.Content(Model.ProfilePicture);
}

<div class="container mt-4 mb-5">

    <!-- ================= IMAGE SECTION ================= -->
    <div class="card shadow-sm mb-4 overflow-hidden">

        <label for="ProfileImageInput" style="cursor:pointer;">
            <img id="profilePreview"
                 src="@profileImage"
                 class="d-block w-100 img-fluid bg-light"
                 style="max-height:420px; object-fit:contain;"
                 title="@Localizer["ClickToChangePicture"]" />
        </label>

    </div>

    <!-- ================= DETAILS / EDIT SECTION ================= -->
    <div class="card shadow-sm">
        <div class="card-body">

            <form asp-action="Edit"
                  method="post"
                  enctype="multipart/form-data">

                @Html.AntiForgeryToken()

                <!-- REQUIRED -->
                <input type="hidden" asp-for="UserId" />

                <!-- IMAGE INPUT -->
                <input type="file"
                       id="ProfileImageInput"
                       name="profileImage"
                       accept="image/*"
                       hidden />

                <div asp-validation-summary="ModelOnly"
                     class="text-danger mb-3"></div>

                <!-- NAME -->
                <h3 class="fw-bold mb-1">@Model.FullName</h3>

                <!-- META LINE -->
                <div class="text-muted small d-flex align-items-center flex-wrap gap-3 mb-4">

                    <span class="badge bg-primary">
                        <i class="bi bi-person-badge"></i>
                        @(Model.Role?.RoleName ?? Localizer["NoRole"].Value)
                    </span>

                    <span class="d-flex align-items-center gap-1">
                        <i class="bi bi-envelope"></i>
                        @Model.Email
                    </span>

                    <span class="d-flex align-items-center gap-1">
                        <i class="bi bi-telephone"></i>
                        @Model.PhoneNumber
                    </span>

                </div>

                <hr />

                <!-- ROLE -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        @Localizer["Role"]
                    </label>
                    <select asp-for="RoleId"
                            class="form-select"
                            asp-items="ViewBag.RoleId">
                    </select>
                    <span asp-validation-for="RoleId" class="text-danger"></span>
                </div>

                <!-- FULL NAME -->
                <div class="mb-3">
                    <label asp-for="FullName" class="form-label fw-semibold"></label>
                    <input asp-for="FullName" class="form-control" />
                    <span asp-validation-for="FullName" class="text-danger"></span>
                </div>

                <!-- EMAIL -->
                <div class="mb-3">
                    <label asp-for="Email" class="form-label fw-semibold"></label>
                    <input asp-for="Email"
                           type="email"
                           class="form-control" />
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>

                <!-- PHONE -->
                <div class="mb-4">
                    <label asp-for="PhoneNumber" class="form-label fw-semibold"></label>
                    <input asp-for="PhoneNumber" class="form-control" />
                    <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                </div>

                <hr />

                <!-- ACTIONS -->
                <div class="d-flex justify-content-between flex-wrap gap-2">

                    <button type="submit"
                            class="btn btn-primary">
                        <i class="bi bi-check-circle"></i>
                        @Localizer["SaveChanges"]
                    </button>

                    <button type="button"
                            class="btn btn-secondary"
                            onclick="history.back()">
                        <i class="bi bi-arrow-left"></i>
                        @Localizer["Back"]
                    </button>

                </div>

            </form>

        </div>
    </div>

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const input = document.getElementById("ProfileImageInput");
            const preview = document.getElementById("profilePreview");

            preview.addEventListener("click", () => input.click());

            input.addEventListener("change", e => {
                const file = e.target.files[0];
                if (!file || !file.type.startsWith("image")) return;

                const reader = new FileReader();
                reader.onload = ev => preview.src = ev.target.result;
                reader.readAsDataURL(file);
            });
        });
    </script>
}
